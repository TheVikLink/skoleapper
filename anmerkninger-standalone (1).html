<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#007AFF">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Anmerkninger</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
            -webkit-tap-highlight-color: transparent;
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        h1 {
            color: #333;
            margin-bottom: 30px;
            text-align: center;
            font-size: 24px;
        }

        h2 {
            color: #333;
            margin-bottom: 20px;
            text-align: center;
            font-size: 20px;
        }

        .button {
            width: 100%;
            padding: 18px;
            margin-bottom: 15px;
            background-color: #007AFF;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
            box-shadow: 0 2px 8px rgba(0, 122, 255, 0.3);
            -webkit-appearance: none;
        }

        .button:active {
            background-color: #0051D5;
            transform: scale(0.98);
        }

        .button.secondary {
            background-color: #34C759;
        }

        .button.secondary:active {
            background-color: #248A3D;
        }

        .back-button {
            width: 100%;
            padding: 14px;
            margin-bottom: 20px;
            background-color: #8E8E93;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            cursor: pointer;
            -webkit-appearance: none;
        }

        .back-button:active {
            background-color: #636366;
        }

        .student-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .student-button {
            padding: 20px;
            background-color: white;
            border: 2px solid #E5E5EA;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            -webkit-appearance: none;
        }

        .student-button.selected {
            background-color: #007AFF;
            color: white;
            border-color: #007AFF;
        }

        .confirm-button {
            width: 100%;
            padding: 18px;
            background-color: #cccccc;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: not-allowed;
            margin-top: 10px;
            -webkit-appearance: none;
        }

        .confirm-button.active {
            background-color: #34C759;
            cursor: pointer;
        }

        .confirm-button.active:active {
            background-color: #248A3D;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 16px;
            text-align: center;
            max-width: 80%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .modal-content p {
            font-size: 18px;
            margin-bottom: 20px;
            color: #333;
        }

        .modal-button {
            padding: 12px 30px;
            background-color: #007AFF;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            -webkit-appearance: none;
        }

        .input-container {
            margin-bottom: 20px;
        }

        .input-container input {
            width: 100%;
            padding: 14px;
            border: 2px solid #E5E5EA;
            border-radius: 12px;
            font-size: 16px;
            margin-top: 10px;
            -webkit-appearance: none;
        }

        textarea {
            -webkit-appearance: none;
        }
    </style>
</head>
<body>

    <!-- Hjemskjerm -->
    <div id="home-screen" class="screen active">
        <h1>üìù Anmerkninger</h1>
        <button class="button" onclick="goToCategory()">Registrer ny anmerkning</button>
        <button class="button secondary" onclick="exportData()">Eksporter data</button>
        <p style="text-align: center; margin-top: 20px; color: #666; font-size: 14px;">
            Antall registrerte: <span id="remark-count">0</span>
        </p>
    </div>

    <!-- Kategori-skjerm -->
    <div id="category-screen" class="screen">
        <button class="back-button" onclick="goToHome()">‚Üê Tilbake</button>
        <h2>Velg kategori</h2>
        <button class="button" onclick="selectCategory('orden')">Orden</button>
        <button class="button secondary" onclick="selectCategory('oppf√∏rsel')">Oppf√∏rsel</button>
    </div>

    <!-- Anmerkningstype-skjerm (Orden) -->
    <div id="orden-screen" class="screen">
        <button class="back-button" onclick="goToCategory()">‚Üê Tilbake</button>
        <h2>Velg anmerkning - Orden</h2>
        <button class="button" onclick="selectRemark('For sen til timen')">For sen til timen</button>
        <button class="button" onclick="selectRemark('Ikke med gymt√∏y')">Ikke med gymt√∏y</button>
        <button class="button" onclick="selectRemark('Ikke med innesko til gym')">Ikke med innesko til gym</button>
        <button class="button" onclick="selectRemark('Ikke med n√∏dvendig utstyr til timen')">Ikke med n√∏dvendig utstyr til timen</button>
        <div class="input-container">
            <button class="button" onclick="showOtherInput()">Annet</button>
            <input type="text" id="other-input" placeholder="Skriv inn anmerkning..." style="display: none;">
        </div>
    </div>

    <!-- Anmerkningstype-skjerm (Oppf√∏rsel) -->
    <div id="oppforsel-screen" class="screen">
        <button class="back-button" onclick="goToCategory()">‚Üê Tilbake</button>
        <h2>Velg anmerkning - Oppf√∏rsel</h2>
        <button class="button" onclick="selectRemark('Forstyrrer undervisningen')">Forstyrrer undervisningen</button>
        <button class="button" onclick="selectRemark('Respektl√∏s oppf√∏rsel')">Respektl√∏s oppf√∏rsel</button>
        <button class="button" onclick="selectRemark('Mobbing/krenkende adferd')">Mobbing/krenkende adferd</button>
        <button class="button" onclick="selectRemark('Ufint spr√•k')">Ufint spr√•k</button>
        <div class="input-container">
            <button class="button" onclick="showOtherInput()">Annet</button>
            <input type="text" id="other-input-oppforsel" placeholder="Skriv inn anmerkning..." style="display: none;">
        </div>
    </div>

    <!-- Elevvalg-skjerm -->
    <div id="student-screen" class="screen">
        <button class="back-button" onclick="goBackFromStudents()">‚Üê Tilbake</button>
        <h2>Velg elev(er)</h2>
        <p style="text-align: center; margin-bottom: 15px; color: #666;">Velg en eller flere elever</p>
        <div class="student-grid" id="student-grid"></div>
        <button class="confirm-button" id="confirm-button" onclick="confirmSelection()">Ferdig</button>
    </div>

    <!-- Modal for bekreftelse -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <p id="modal-message">Anmerkning registrert!</p>
            <button class="modal-button" onclick="closeModal()">OK</button>
        </div>
    </div>

    <script>
        // Globale variabler
        let currentCategory = '';
        let currentRemark = '';
        let selectedStudents = [];
        let remarks = JSON.parse(localStorage.getItem('remarks')) || [];

        // Generer elevknapper
        function generateStudentButtons() {
            const grid = document.getElementById('student-grid');
            grid.innerHTML = '';
            for (let i = 1; i <= 23; i++) {
                const button = document.createElement('button');
                button.className = 'student-button';
                button.textContent = i;
                button.onclick = function() { toggleStudent(i, button); };
                grid.appendChild(button);
            }
        }

        // Toggle elevvalg
        function toggleStudent(studentNum, button) {
            if (selectedStudents.includes(studentNum)) {
                selectedStudents = selectedStudents.filter(function(s) { return s !== studentNum; });
                button.classList.remove('selected');
            } else {
                selectedStudents.push(studentNum);
                button.classList.add('selected');
            }
            updateConfirmButton();
        }

        // Oppdater ferdig-knapp
        function updateConfirmButton() {
            const button = document.getElementById('confirm-button');
            if (selectedStudents.length > 0) {
                button.classList.add('active');
            } else {
                button.classList.remove('active');
            }
        }

        // Navigasjonsfunksjoner
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(function(s) { s.classList.remove('active'); });
            document.getElementById(screenId).classList.add('active');
        }

        function goToHome() {
            showScreen('home-screen');
            resetState();
            updateRemarkCount();
        }

        function goToCategory() {
            showScreen('category-screen');
        }

        function selectCategory(category) {
            currentCategory = category;
            if (category === 'orden') {
                showScreen('orden-screen');
            } else {
                showScreen('oppforsel-screen');
            }
        }

        function showOtherInput() {
            const inputId = currentCategory === 'orden' ? 'other-input' : 'other-input-oppforsel';
            const input = document.getElementById(inputId);
            input.style.display = 'block';
            input.focus();
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && input.value.trim()) {
                    selectRemark('Annet: ' + input.value.trim());
                }
            });
        }

        function selectRemark(remark) {
            const otherInputOrden = document.getElementById('other-input');
            const otherInputOppforsel = document.getElementById('other-input-oppforsel');
            
            if (remark === 'Annet' && currentCategory === 'orden' && otherInputOrden.value.trim()) {
                currentRemark = 'Annet: ' + otherInputOrden.value.trim();
            } else if (remark === 'Annet' && currentCategory === 'oppf√∏rsel' && otherInputOppforsel.value.trim()) {
                currentRemark = 'Annet: ' + otherInputOppforsel.value.trim();
            } else {
                currentRemark = remark;
            }
            
            generateStudentButtons();
            showScreen('student-screen');
        }

        function goBackFromStudents() {
            if (currentCategory === 'orden') {
                showScreen('orden-screen');
            } else {
                showScreen('oppforsel-screen');
            }
            selectedStudents = [];
        }

        function confirmSelection() {
            if (selectedStudents.length === 0) return;

            const timestamp = new Date().toISOString();
            selectedStudents.forEach(function(studentNum) {
                remarks.push({
                    studentNumber: studentNum,
                    category: currentCategory,
                    remark: currentRemark,
                    timestamp: timestamp
                });
            });

            localStorage.setItem('remarks', JSON.stringify(remarks));
            
            document.getElementById('modal-message').textContent = 'Anmerkning registrert!';
            document.getElementById('modal').classList.add('show');
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('show');
            goToHome();
        }

        function updateRemarkCount() {
            const countElement = document.getElementById('remark-count');
            if (countElement) {
                countElement.textContent = remarks.length;
            }
        }

        function resetState() {
            currentCategory = '';
            currentRemark = '';
            selectedStudents = [];
            document.getElementById('other-input').style.display = 'none';
            document.getElementById('other-input').value = '';
            document.getElementById('other-input-oppforsel').style.display = 'none';
            document.getElementById('other-input-oppforsel').value = '';
        }

        function showReportOnScreen(report) {
            const modal = document.getElementById('modal');
            const modalContent = modal.querySelector('.modal-content');
            modalContent.innerHTML = '<h3 style="margin-bottom: 15px;">Rapport generert</h3><p style="margin-bottom: 15px; font-size: 14px;">Kopier teksten under:</p><textarea readonly style="width: 100%; height: 300px; padding: 10px; font-family: monospace; font-size: 12px; border: 1px solid #ccc; border-radius: 8px;">' + report + '</textarea><div style="margin-top: 15px;"><button class="modal-button" onclick="copyReport()">Kopier tekst</button><button class="modal-button" style="background-color: #8E8E93; margin-left: 10px;" onclick="closeReportModal()">Lukk</button></div>';
            modal.classList.add('show');
        }

        function copyReport() {
            const textarea = document.querySelector('#modal textarea');
            textarea.select();
            try {
                document.execCommand('copy');
                alert('Rapport kopiert!');
            } catch (e) {
                alert('Kunne ikke kopiere automatisk. Marker teksten og kopier manuelt.');
            }
        }

        function closeReportModal() {
            const modal = document.getElementById('modal');
            modal.classList.remove('show');
            
            if (confirm('Slette alle anmerkninger n√•?')) {
                remarks = [];
                localStorage.setItem('remarks', JSON.stringify(remarks));
                updateRemarkCount();
                alert('Alle anmerkninger er slettet.');
                goToHome();
            }
        }

        // Eksporter data
        function exportData() {
            try {
                console.log('exportData kj√∏rt, antall anmerkninger:', remarks.length);
                
                if (remarks.length === 0) {
                    alert('Ingen anmerkninger √• eksportere. Registrer noen anmerkninger f√∏rst.');
                    return;
                }

                if (!confirm('Eksportere data og slette alle anmerkninger? Dette kan ikke angres.')) {
                    return;
                }

                const remarkData = {};
                
                remarks.forEach(function(r) {
                    const key = r.category + '|' + r.remark;
                    if (!remarkData[key]) {
                        remarkData[key] = {
                            category: r.category,
                            remark: r.remark,
                            students: []
                        };
                    }
                    remarkData[key].students.push({
                        number: r.studentNumber,
                        timestamp: r.timestamp
                    });
                });

                let report = 'ANMERKNINGSRAPPORT\n';
                report += '===================\n\n';
                report += 'Generert: ' + new Date().toLocaleString('no-NO') + '\n\n';
                report += 'ANMERKNINGER:\n';
                report += '=============\n\n';

                const sortedRemarks = Object.values(remarkData).sort(function(a, b) {
                    if (a.category !== b.category) {
                        return a.category.localeCompare(b.category);
                    }
                    return a.remark.localeCompare(b.remark);
                });

                sortedRemarks.forEach(function(item) {
                    report += item.category.toUpperCase() + ': ' + item.remark + '\n';
                    const studentNumbers = item.students.map(function(s) { return s.number; }).sort(function(a, b) { return a - b; }).join(', ');
                    report += 'Elever: ' + studentNumbers + '\n';
                    report += 'Tidspunkt: ' + new Date(item.students[0].timestamp).toLocaleString('no-NO') + '\n';
                    report += '\n';
                });

                report += '\nSTATISTIKK:\n';
                report += '===========\n';
                report += 'Totalt antall anmerkninger: ' + remarks.length + '\n';
                const ordenCount = remarks.filter(function(r) { return r.category === 'orden'; }).length;
                const oppforselCount = remarks.filter(function(r) { return r.category === 'oppf√∏rsel'; }).length;
                report += 'Orden: ' + ordenCount + '\n';
                report += 'Oppf√∏rsel: ' + oppforselCount + '\n';

                // Vis rapporten p√• skjermen i stedet for √• laste ned
                showReportOnScreen(report);
                
            } catch (error) {
                alert('Feil ved eksport: ' + error.message);
                console.error('Eksportfeil:', error);
            }
        }

        // Last inn n√•r siden lastes
        window.onload = function() {
            generateStudentButtons();
            updateRemarkCount();
        };
    </script>

</body>
</html>
